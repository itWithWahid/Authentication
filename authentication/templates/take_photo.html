{% load static %}<!DOCTYPE html>
<html>
  <head>
    <title>Registration</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"
      integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static 'style.css' %}" />
  </head>
  <body>
    <div class="container h-100">
      <div class="d-flex justify-content-center h-100">
        <div class="user_card">
          <h3 id="form-title">REGISTER ACCOUNT</h3>
          <h3 id="form-title">
            স্পষ্ট ছবি তুলুন। একাধিক মুখ যেন ছবিতে না থাকে।
          </h3>
          <div class="form_container">
            <!-- Camera Section -->
            <div class="container_frame">
              <div class="camera">
                <video id="video">Video stream not available.</video>
                <div><button id="startbutton">Take photo</button></div>
              </div>

              <canvas id="canvas"></canvas>
              <!-- Output Photo -->
              <div class="output_frame">
                <div class="output">
                  <img
                    id="photo"
                    alt="The screen capture will appear in this box."
                  />
                </div>
                <div>
                  <a href="{% url 'home' %}"
                  ><input
                    class="btn"
                    type="submit"
                    value="SUBMIT"
                /></a>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
        </div>
      </div>
    </div>
    <script>
        /* JS comes here */
        (function () {
          var width = 400; // We will scale the photo width to this
          var height = 0; // This will be computed based on the input stream

          var streaming = false;

          var video = null;
          var canvas = null;
          var photo = null;
          var startbutton = null;

          function startup() {
            video = document.getElementById("video");
            canvas = document.getElementById("canvas");
            photo = document.getElementById("photo");
            startbutton = document.getElementById("startbutton");

            navigator.mediaDevices
              .getUserMedia({
                video: true,
                audio: false,
              })
              .then(function (stream) {
                video.srcObject = stream;
                video.play();
              })
              .catch(function (err) {
                console.log("An error occurred: " + err);
              });

            video.addEventListener(
              "canplay",
              function (ev) {
                if (!streaming) {
                  height = video.videoHeight / (video.videoWidth / width);

                  if (isNaN(height)) {
                    height = width / (4 / 3);
                  }

                  video.setAttribute("width", width);
                  video.setAttribute("height", height);
                  canvas.setAttribute("width", width);
                  canvas.setAttribute("height", height);
                  streaming = true;
                }
              },
              false
            );

            startbutton.addEventListener(
              "click",
              function (ev) {
                takepicture();
                savePhoto();
                ev.preventDefault();
              },
              false
            );

            clearphoto();
          }

          function clearphoto() {
            var context = canvas.getContext("2d");
            context.fillStyle = "#AAA";
            context.fillRect(0, 0, canvas.width, canvas.height);

            var data = canvas.toDataURL("image/png");
            photo.setAttribute("src", data);
          }

          function takepicture() {
            var context = canvas.getContext("2d");
            if (width && height) {
              canvas.width = width;
              canvas.height = height;
              context.drawImage(video, 0, 0, width, height);

              var data = canvas.toDataURL("image/png");
              photo.setAttribute("src", data);
            } else {
              clearphoto();
            }
          }
          // Function to send the captured image data to the Django view
          function savePhoto() {
            // Get the base64 encoded image data
            var imageData = document
              .getElementById("canvas")
              .toDataURL("image/jpeg");
      // Check if imageData is null or empty

            // Get the CSRF token
            var csrftoken = getCookie("csrftoken");

            // Send the image data to the Django view using AJAX
            $.ajax({
              type: "POST",
              url: "/authentication/save_image/",
              data: {
                image_data: imageData,
                id : {{ id }}
              },
              beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken); // Include CSRF token in the request headers
              },
              success: function (response) {
                alert("Image saved successfully!");
              },
              error: function (xhr, status, error) {
                alert("An error occurred while saving the image.");
              },
            });
          }

          // Function to get the CSRF token from cookies
          function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== "") {
              var cookies = document.cookie.split(";");
              for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === name + "=") {
                  cookieValue = decodeURIComponent(
                    cookie.substring(name.length + 1)
                  );
                  break;
                }
              }
            }
            return cookieValue;
          }

          window.addEventListener("load", startup, false);
        })();
    </script>
  </body>
</html>
